import { Component, Input, Output, EventEmitter, ChangeDetectionStrategy, Optional, } from '@angular/core';
import { NavigationEnd } from '@angular/router';
import { BuilderComponentService } from './builder-component.service';
import { Builder } from '@builder.io/sdk';
import { Subscription, BehaviorSubject } from 'rxjs';
import { ANGULAR_LATEST_VERSION, SCRIPT_ID } from '../../utils/constants';
import * as i0 from "@angular/core";
import * as i1 from "../../services/builder.service";
import * as i2 from "@angular/router";
import * as i3 from "@angular/common";
import * as i4 from "../builder-content/builder-content.component";
import * as i5 from "../builder-blocks/builder-blocks.component";
import * as i6 from "../../directives/builder-content.directive";
function omit(obj, ...values) {
    const newObject = Object.assign({}, obj);
    for (const key of values) {
        delete newObject[key];
    }
    return newObject;
}
let wcScriptInserted = false;
const NAVIGATION_TIMEOUT_DEFAULT = 1000;
function delay(duration, resolveValue) {
    return new Promise((resolve) => setTimeout(() => resolve(resolveValue), duration));
}
export class BuilderComponentComponent {
    viewContainer;
    elementRef;
    builderService;
    router;
    model;
    set name(name) {
        this.model = name;
    }
    handleRouting = true;
    reloadOnRoute = true;
    load = new EventEmitter();
    route = new EventEmitter();
    error = new EventEmitter();
    content = null;
    options = null;
    data = {};
    context = {};
    hydrate = true;
    prerender = true;
    // Sometimes user will have slow connection and when we are using Resolver on target route
    // then, application will be fully reloaded. In that case set it to false to avoid full-reload navigation.
    navigationTimeout = NAVIGATION_TIMEOUT_DEFAULT;
    subscriptions = new Subscription();
    visible = new BehaviorSubject(true);
    get url() {
        const location = this.builderService.getLocation();
        return location.pathname || '';
    }
    get key() {
        const key = Builder.isEditing || !this.reloadOnRoute ? this.model : `${this.model}:${this.url}`;
        return key;
    }
    constructor(viewContainer, elementRef, builderService, router) {
        this.viewContainer = viewContainer;
        this.elementRef = elementRef;
        this.builderService = builderService;
        this.router = router;
    }
    async ensureWCScriptLoaded() {
        if (!Builder.isBrowser || wcScriptInserted || document.getElementById(SCRIPT_ID)) {
            return;
        }
        function getQueryParam(url, variable) {
            const query = url.split('?')[1] || '';
            const vars = query.split('&');
            for (let i = 0; i < vars.length; i++) {
                const pair = vars[i].split('=');
                if (decodeURIComponent(pair[0]) === variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
            return null;
        }
        const script = document.createElement('script');
        const wcVersion = getQueryParam(location.href, 'builder.wcVersion') || ANGULAR_LATEST_VERSION;
        script.id = SCRIPT_ID;
        // TODO: detect builder.wcVersion and if customEleemnts exists and do
        // dynamic versions and lite here
        script.src = `https://cdn.builder.io/js/webcomponents@${wcVersion || 'latest'}/dist/system/angular/builder-webcomponents-async.js`;
        script.async = true;
        wcScriptInserted = true;
        return new Promise((resolve, reject) => {
            script.addEventListener('load', resolve);
            script.addEventListener('error', (e) => reject(e.error));
            document.head.appendChild(script);
        });
    }
    async ensureWcLoadedAndUpdate() {
        await this.ensureWCScriptLoaded();
        const { onBuilderWcLoad } = window;
        if (onBuilderWcLoad) {
            onBuilderWcLoad((BuilderWC) => {
                const builder = BuilderWC.builder;
                builder.apiKey = this.builderService.apiKey;
                builder.canTrack = this.builderService.canTrack;
                builder.setUserAttributes(omit(this.builderService.getUserAttributes(), 'urlPath'));
                this.builderService.userAttributesChanged.subscribe((attrs) => builder.setUserAttributes(attrs));
                this.triggerstateChange();
            });
        }
    }
    ngOnInit() {
        if (this.router && this.reloadOnRoute) {
            // TODO: should the inner function return reloadOnRoute?
            this.router.routeReuseStrategy.shouldReuseRoute = () => false;
        }
        if (Builder.isBrowser) {
            if (this.router) {
                this.subscriptions.add(this.router.events.subscribe((event) => {
                    if (event instanceof NavigationEnd) {
                        if (this.reloadOnRoute) {
                            // Force reload component
                            this.visible.next(false);
                            Builder.nextTick(() => {
                                this.visible.next(true);
                            });
                        }
                    }
                }));
            }
            this.subscriptions.add(this.load.subscribe(async (value) => {
                // TODO: this may run constantly when editing - check on this, not
                // end of world but not ideal for perf
                this.viewContainer.detach();
                if (Builder.isEditing || (value && value.data && this.hydrate !== false)) {
                    await this.ensureWcLoadedAndUpdate();
                }
            }));
        }
        if (Builder.isBrowser && (this.hydrate !== false || Builder.isEditing)) {
            this.ensureWcLoadedAndUpdate();
        }
    }
    async triggerstateChange() {
        const query = `builder-component-element[name="${this.model}"]`;
        const element = document.querySelector(query);
        if (element) {
            customElements.whenDefined('builder-component-element').then(() => {
                element.setState(this.data);
                element.setContext(this.context);
            });
        }
    }
    ngOnChanges(changes) {
        if (changes.data) {
            this.triggerstateChange();
        }
    }
    ngOnDestroy() {
        this.subscriptions.unsubscribe();
    }
    // TODO: this should be in BuilderBlocks
    async onClick(event) {
        if (!this.handleRouting) {
            return;
        }
        if (event.button !== 0 || event.ctrlKey || event.defaultPrevented) {
            // If this is a non-left click, or the user is holding ctr/cmd, or the url is absolute,
            // or if the link has a target attribute, don't route on the client and let the default
            // href property handle the navigation
            return;
        }
        const hrefTarget = this.findHrefTarget(event);
        if (!hrefTarget) {
            return;
        }
        // target="_blank" or target="_self" etc
        if (hrefTarget.target) {
            return;
        }
        let href = hrefTarget.getAttribute('href');
        if (!href) {
            return;
        }
        if (href.startsWith('javascript:')) {
            return;
        }
        const routeEvent = {
            url: href,
            anchorNode: hrefTarget,
            preventDefault() {
                this.defaultPrevented = true;
            },
            defaultPrevented: false,
        };
        this.route.next(routeEvent);
        if (routeEvent.defaultPrevented) {
            event.preventDefault();
            return;
        }
        if (event.metaKey) {
            return;
        }
        if (!this.isRelative(href)) {
            const converted = this.convertToRelative(href);
            if (converted) {
                href = converted;
            }
            else {
                return;
            }
        }
        if (!this.router) {
            return;
        }
        // Otherwise if this url is relative, navigate on the client
        event.preventDefault();
        // Attempt to route on the client
        let success = null;
        const routePromise = this.router.navigateByUrl(href);
        const useNavigationTimeout = !(typeof this.navigationTimeout === 'boolean' && !this.navigationTimeout);
        const timeoutPromise = delay(typeof this.navigationTimeout === 'number'
            ? this.navigationTimeout
            : NAVIGATION_TIMEOUT_DEFAULT, false);
        try {
            const promiseRace = useNavigationTimeout ? [timeoutPromise, routePromise] : [routePromise];
            success = await Promise.race(promiseRace);
        }
        finally {
            // This is in a click handler so it will only run on the client
            if (success) {
                // If successful scroll the window to the top
                window.scrollTo(0, 0);
            }
            else {
                // Otherwise handle the routing with a page refresh on failure. Angular, by deafult
                // if it fails to load a URL (e.g. if an API request failed when loading it), instead
                // of navigating to the new page to tell the user that their click did something but
                // the resulting page has an issue, it instead just silently fails and shows the user
                // nothing. Lets make sure we route to the new page. In some cases this even brings the
                // user to a correct and valid page anyway
                location.href = `${location.protocol}//${location.host}${href}`;
            }
        }
    }
    isRelative(href) {
        return (!href.match(/^(\/\/|https?:\/\/)/i) &&
            // Handle Mailto and Tel links
            !href.startsWith('tel:') &&
            !href.startsWith('mailto:') &&
            // Handle local hash links
            !href.startsWith('#'));
    }
    // Attempt to convert an absolute url to relative if possible (aka if the hosts match)
    convertToRelative(href) {
        const currentUrl = new URL(location.href);
        const hrefUrl = new URL(href);
        if (currentUrl.host === hrefUrl.host) {
            const relativeUrl = hrefUrl.pathname + (hrefUrl.search ? hrefUrl.search : '');
            return relativeUrl;
        }
    }
    findHrefTarget(event) {
        let element = event.target;
        while (element) {
            if (element instanceof HTMLAnchorElement && element.getAttribute('href')) {
                return element;
            }
            if (element === event.currentTarget) {
                break;
            }
            element = element.parentElement;
        }
        return null;
    }
    static ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.0.6", ngImport: i0, type: BuilderComponentComponent, deps: [{ token: i0.ViewContainerRef }, { token: i0.ElementRef }, { token: i1.BuilderService }, { token: i2.Router, optional: true }], target: i0.ɵɵFactoryTarget.Component });
    static ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "18.0.6", type: BuilderComponentComponent, selector: "builder-component", inputs: { model: "model", name: "name", handleRouting: "handleRouting", reloadOnRoute: "reloadOnRoute", content: "content", options: "options", data: "data", context: "context", hydrate: "hydrate", prerender: "prerender", navigationTimeout: "navigationTimeout" }, outputs: { load: "load", route: "route", error: "error" }, providers: [BuilderComponentService], usesOnChanges: true, ngImport: i0, template: "<span *ngIf=\"visible | async\" class=\"builder-component-wrap\">\n  <span *ngIf=\"!prerender\">\n    <builder-blocks\n      field=\"blocks\"\n      [key]=\"key\"\n      [model]=\"model\"\n      (click)=\"onClick($event)\"\n      [prerender]=\"false\"\n      [options]=\"options\"\n    ></builder-blocks>\n  </span>\n  <span *ngIf=\"prerender\">\n    <builder-content\n      [data]=\"data\"\n      [hydrate]=\"hydrate\"\n      [prerender]=\"prerender\"\n      [content]=\"content\"\n      [options]=\"options\"\n      (click)=\"onClick($event)\"\n      (contentLoad)=\"load.next($event)\"\n      (contentError)=\"error.next($event)\"\n      *builderModel=\"model; let content; let loading = loading; let meta = meta;\"\n    >\n      <builder-blocks\n        *ngIf=\"content\"\n        field=\"blocks\"\n        [key]=\"key\"\n        [model]=\"model\"\n        [prerender]=\"prerender\"\n        [options]=\"options\"\n        [blocks]=\"content.blocks || content\"\n        [breakpoints]=\"(content.meta && content.meta.breakpoints) || (meta && meta.breakpoints) || undefined\"\n      ></builder-blocks>\n      <ng-content *ngIf=\"loading\"></ng-content>\n    </builder-content>\n  </span>\n</span>\n", styles: [":host{display:block}\n"], dependencies: [{ kind: "directive", type: i3.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "component", type: i4.BuilderContentComponent, selector: "builder-content", inputs: ["useHtml", "data", "hydrate", "prerender", "content", "options"], outputs: ["contentLoad", "contentError"] }, { kind: "component", type: i5.BuilderBlocksComponent, selector: "builder-blocks", inputs: ["blocks", "child", "prerender", "model", "key", "options", "field", "breakpoints"] }, { kind: "directive", type: i6.BuilderContentDirective, selector: "[builderModel]", inputs: ["reloadOnRoute", "builderModel"] }, { kind: "pipe", type: i3.AsyncPipe, name: "async" }], changeDetection: i0.ChangeDetectionStrategy.OnPush });
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.0.6", ngImport: i0, type: BuilderComponentComponent, decorators: [{
            type: Component,
            args: [{ selector: 'builder-component', providers: [BuilderComponentService], changeDetection: ChangeDetectionStrategy.OnPush, template: "<span *ngIf=\"visible | async\" class=\"builder-component-wrap\">\n  <span *ngIf=\"!prerender\">\n    <builder-blocks\n      field=\"blocks\"\n      [key]=\"key\"\n      [model]=\"model\"\n      (click)=\"onClick($event)\"\n      [prerender]=\"false\"\n      [options]=\"options\"\n    ></builder-blocks>\n  </span>\n  <span *ngIf=\"prerender\">\n    <builder-content\n      [data]=\"data\"\n      [hydrate]=\"hydrate\"\n      [prerender]=\"prerender\"\n      [content]=\"content\"\n      [options]=\"options\"\n      (click)=\"onClick($event)\"\n      (contentLoad)=\"load.next($event)\"\n      (contentError)=\"error.next($event)\"\n      *builderModel=\"model; let content; let loading = loading; let meta = meta;\"\n    >\n      <builder-blocks\n        *ngIf=\"content\"\n        field=\"blocks\"\n        [key]=\"key\"\n        [model]=\"model\"\n        [prerender]=\"prerender\"\n        [options]=\"options\"\n        [blocks]=\"content.blocks || content\"\n        [breakpoints]=\"(content.meta && content.meta.breakpoints) || (meta && meta.breakpoints) || undefined\"\n      ></builder-blocks>\n      <ng-content *ngIf=\"loading\"></ng-content>\n    </builder-content>\n  </span>\n</span>\n", styles: [":host{display:block}\n"] }]
        }], ctorParameters: () => [{ type: i0.ViewContainerRef }, { type: i0.ElementRef }, { type: i1.BuilderService }, { type: i2.Router, decorators: [{
                    type: Optional
                }] }], propDecorators: { model: [{
                type: Input
            }], name: [{
                type: Input
            }], handleRouting: [{
                type: Input
            }], reloadOnRoute: [{
                type: Input
            }], load: [{
                type: Output
            }], route: [{
                type: Output
            }], error: [{
                type: Output
            }], content: [{
                type: Input
            }], options: [{
                type: Input
            }], data: [{
                type: Input
            }], context: [{
                type: Input
            }], hydrate: [{
                type: Input
            }], prerender: [{
                type: Input
            }], navigationTimeout: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVpbGRlci1jb21wb25lbnQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2FwcC9tb2R1bGVzL2J1aWxkZXIvY29tcG9uZW50cy9idWlsZGVyLWNvbXBvbmVudC9idWlsZGVyLWNvbXBvbmVudC5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi8uLi9zcmMvYXBwL21vZHVsZXMvYnVpbGRlci9jb21wb25lbnRzL2J1aWxkZXItY29tcG9uZW50L2J1aWxkZXItY29tcG9uZW50LmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsS0FBSyxFQUNMLE1BQU0sRUFDTixZQUFZLEVBQ1osdUJBQXVCLEVBQ3ZCLFFBQVEsR0FPVCxNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQVUsYUFBYSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDeEQsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDdEUsT0FBTyxFQUFxQixPQUFPLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsWUFBWSxFQUFFLGVBQWUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUVyRCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsU0FBUyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7Ozs7Ozs7O0FBRTFFLFNBQVMsSUFBSSxDQUFtQixHQUFNLEVBQUUsR0FBRyxNQUFtQjtJQUM1RCxNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUN6QyxLQUFLLE1BQU0sR0FBRyxJQUFJLE1BQU0sRUFBRSxDQUFDO1FBQ3pCLE9BQVEsU0FBaUIsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBQ0QsT0FBTyxTQUFTLENBQUM7QUFDbkIsQ0FBQztBQUVELElBQUksZ0JB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OzBCQTZDNUMsUUFBUTt5Q0ExQ0YsS0FBSztzQkFBYixLQUFLO2dCQUVPLElBQUk7c0JBQWhCLEtBQUs7Z0JBSUcsYUFBYTtzQkFBckIsS0FBSztnQkFDRyxhQUFhO3NCQUFyQixLQUFLO2dCQUVJLElBQUk7c0JBQWIsTUFBTTtnQkFDRyxLQUFLO3NCQUFkLE1BQU07Z0JBQ0csS0FBSztzQkFBZCxNQUFNO2dCQUNFLE9BQU87c0JBQWYsS0FBSztnQkFDRyxPQUFPO3NCQUFmLEtBQUs7Z0JBRUcsSUFBSTtzQkFBWixLQUFLO2dCQUNHLE9BQU87c0JBQWYsS0FBSztnQkFDRyxPQUFPO3NCQUFmLEtBQUs7Z0JBQ0csU0FBUztzQkFBakIsS0FBSztnQkFJRyxpQkFBaUI7c0JBQXpCLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnQsXG4gIElucHV0LFxuICBPdXRwdXQsXG4gIEV2ZW50RW1pdHRlcixcbiAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksXG4gIE9wdGlvbmFsLFxuICBPbkRlc3Ryb3ksXG4gIE9uSW5pdCxcbiAgT25DaGFuZ2VzLFxuICBWaWV3Q29udGFpbmVyUmVmLFxuICBFbGVtZW50UmVmLFxuICBTaW1wbGVDaGFuZ2VzLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFJvdXRlciwgTmF2aWdhdGlvbkVuZCB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBCdWlsZGVyQ29tcG9uZW50U2VydmljZSB9IGZyb20gJy4vYnVpbGRlci1jb21wb25lbnQuc2VydmljZSc7XG5pbXBvcnQgeyBHZXRDb250ZW50T3B0aW9ucywgQnVpbGRlciB9IGZyb20gJ0BidWlsZGVyLmlvL3Nkayc7XG5pbXBvcnQgeyBTdWJzY3JpcHRpb24sIEJlaGF2aW9yU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQnVpbGRlclNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9idWlsZGVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgQU5HVUxBUl9MQVRFU1RfVkVSU0lPTiwgU0NSSVBUX0lEIH0gZnJvbSAnLi4vLi4vdXRpbHMvY29uc3RhbnRzJztcblxuZnVuY3Rpb24gb21pdDxUIGV4dGVuZHMgb2JqZWN0PihvYmo6IFQsIC4uLnZhbHVlczogKGtleW9mIFQpW10pOiBQYXJ0aWFsPFQ+IHtcbiAgY29uc3QgbmV3T2JqZWN0ID0gT2JqZWN0LmFzc2lnbih7fSwgb2JqKTtcbiAgZm9yIChjb25zdCBrZXkgb2YgdmFsdWVzKSB7XG4gICAgZGVsZXRlIChuZXdPYmplY3QgYXMgYW55KVtrZXldO1xuICB9XG4gIHJldHVybiBuZXdPYmplY3Q7XG59XG5cbmxldCB3Y1NjcmlwdEluc2VydGVkID0gZmFsc2U7XG5jb25zdCBOQVZJR0FUSU9OX1RJTUVPVVRfREVGQVVMVCA9IDEwMDA7XG5cbmZ1bmN0aW9uIGRlbGF5PFQgPSBhbnk+KGR1cmF0aW9uOiBudW1iZXIsIHJlc29sdmVWYWx1ZT86IFQpIHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlPFQ+KChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KCgpID0+IHJlc29sdmUocmVzb2x2ZVZhbHVlISksIGR1cmF0aW9uKSk7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUm91dGVFdmVudCB7XG4gIC8qKlxuICAgKiBVcmwgYmVpbmcgcm91dGVkIHRvXG4gICAqL1xuICB1cmw6IHN0cmluZztcbiAgLyoqXG4gICAqIEh0bWwgYW5jaG9yIGVsZW1lbnQgdGhlIGhyZWYgaXMgb24gdGhhdFxuICAgKiBjYXVzZWQgdGhlIHJvdXRlXG4gICAqL1xuICBhbmNob3JOb2RlOiBIVE1MQW5jaG9yRWxlbWVudDtcbiAgLyoqXG4gICAqIEhhcyBwcmV2ZW50RGVmYXVsdCgpIGJlZW4gY2FsbGVkIHByZXZlbnRpbmdcbiAgICogYnVpbGRlciBmcm9tIHJvdXRpbmcgdG8gdGhlIGNsaWNrZWQgVVJMXG4gICAqL1xuICBkZWZhdWx0UHJldmVudGVkOiBib29sZWFuO1xuICAvKipcbiAgICogUHJldmVudHMgYnVpbGRlciBmcm9tIGhhbmRsaW5nIHJvdXRpbmcgZm9yIHlvdSB0byBoYW5kbGVcbiAgICogeW91cnNlbGZcbiAgICovXG4gIHByZXZlbnREZWZhdWx0KCk6IHZvaWQ7XG59XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2J1aWxkZXItY29tcG9uZW50JyxcbiAgdGVtcGxhdGVVcmw6ICcuL2J1aWxkZXItY29tcG9uZW50LmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vYnVpbGRlci1jb21wb25lbnQuY29tcG9uZW50LmNzcyddLFxuICBwcm92aWRlcnM6IFtCdWlsZGVyQ29tcG9uZW50U2VydmljZV0sXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxufSlcbmV4cG9ydCBjbGFzcyBCdWlsZGVyQ29tcG9uZW50Q29tcG9uZW50IGltcGxlbWVudHMgT25EZXN0cm95LCBPbkluaXQsIE9uQ2hhbmdlcyB7XG4gIEBJbnB1dCgpIG1vZGVsOiBzdHJpbmcgfCB1bmRlZmluZWQgLyogVEhJUyBJUyBBQ1RVQUxMWSBSRVFVSVJFRCAqLztcblxuICBASW5wdXQoKSBzZXQgbmFtZShuYW1lOiBzdHJpbmcgfCB1bmRlZmluZWQpIHtcbiAgICB0aGlzLm1vZGVsID0gbmFtZTtcbiAgfVxuXG4gIEBJbnB1dCgpIGhhbmRsZVJvdXRpbmcgPSB0cnVlO1xuICBASW5wdXQoKSByZWxvYWRPblJvdXRlID0gdHJ1ZTtcblxuICBAT3V0cHV0KCkgbG9hZCA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICBAT3V0cHV0KCkgcm91dGUgPSBuZXcgRXZlbnRFbWl0dGVyPFJvdXRlRXZlbnQ+KCk7XG4gIEBPdXRwdXQoKSBlcnJvciA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICBASW5wdXQoKSBjb250ZW50OiBhbnkgPSBudWxsO1xuICBASW5wdXQoKSBvcHRpb25zOiBHZXRDb250ZW50T3B0aW9ucyB8IG51bGwgPSBudWxsO1xuXG4gIEBJbnB1dCgpIGRhdGE6IGFueSA9IHt9O1xuICBASW5wdXQoKSBjb250ZXh0OiBhbnkgPSB7fTtcbiAgQElucHV0KCkgaHlkcmF0ZSA9IHRydWU7XG4gIEBJbnB1dCgpIHByZXJlbmRlciA9IHRydWU7XG5cbiAgLy8gU29tZXRpbWVzIHVzZXIgd2lsbCBoYXZlIHNsb3cgY29ubmVjdGlvbiBhbmQgd2hlbiB3ZSBhcmUgdXNpbmcgUmVzb2x2ZXIgb24gdGFyZ2V0IHJvdXRlXG4gIC8vIHRoZW4sIGFwcGxpY2F0aW9uIHdpbGwgYmUgZnVsbHkgcmVsb2FkZWQuIEluIHRoYXQgY2FzZSBzZXQgaXQgdG8gZmFsc2UgdG8gYXZvaWQgZnVsbC1yZWxvYWQgbmF2aWdhdGlvbi5cbiAgQElucHV0KCkgbmF2aWdhdGlvblRpbWVvdXQ6IG51bWJlciB8IGJvb2xlYW4gPSBOQVZJR0FUSU9OX1RJTUVPVVRfREVGQVVMVDtcblxuICBzdWJzY3JpcHRpb25zID0gbmV3IFN1YnNjcmlwdGlvbigpO1xuXG4gIHZpc2libGUgPSBuZXcgQmVoYXZpb3JTdWJqZWN0KHRydWUpO1xuXG4gIHByaXZhdGUgZ2V0IHVybCgpIHtcbiAgICBjb25zdCBsb2NhdGlvbiA9IHRoaXMuYnVpbGRlclNlcnZpY2UuZ2V0TG9jYXRpb24oKTtcbiAgICByZXR1cm4gbG9jYXRpb24ucGF0aG5hbWUgfHwgJyc7XG4gIH1cblxuICBnZXQga2V5KCkge1xuICAgIGNvbnN0IGtleSA9IEJ1aWxkZXIuaXNFZGl0aW5nIHx8ICF0aGlzLnJlbG9hZE9uUm91dGUgPyB0aGlzLm1vZGVsIDogYCR7dGhpcy5tb2RlbH06JHt0aGlzLnVybH1gO1xuICAgIHJldHVybiBrZXk7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHZpZXdDb250YWluZXI6IFZpZXdDb250YWluZXJSZWYsXG4gICAgcHJpdmF0ZSBlbGVtZW50UmVmOiBFbGVtZW50UmVmLFxuICAgIHByaXZhdGUgYnVpbGRlclNlcnZpY2U6IEJ1aWxkZXJTZXJ2aWNlLFxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgcm91dGVyPzogUm91dGVyXG4gICkge31cblxuICBhc3luYyBlbnN1cmVXQ1NjcmlwdExvYWRlZCgpIHtcbiAgICBpZiAoIUJ1aWxkZXIuaXNCcm93c2VyIHx8IHdjU2NyaXB0SW5zZXJ0ZWQgfHwgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoU0NSSVBUX0lEKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBmdW5jdGlvbiBnZXRRdWVyeVBhcmFtKHVybDogc3RyaW5nLCB2YXJpYWJsZTogc3RyaW5nKSB7XG4gICAgICBjb25zdCBxdWVyeSA9IHVybC5zcGxpdCgnPycpWzFdIHx8ICcnO1xuICAgICAgY29uc3QgdmFycyA9IHF1ZXJ5LnNwbGl0KCcmJyk7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3QgcGFpciA9IHZhcnNbaV0uc3BsaXQoJz0nKTtcbiAgICAgICAgaWYgKGRlY29kZVVSSUNvbXBvbmVudChwYWlyWzBdKSA9PT0gdmFyaWFibGUpIHtcbiAgICAgICAgICByZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KHBhaXJbMV0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgY29uc3Qgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7XG4gICAgY29uc3Qgd2NWZXJzaW9uID0gZ2V0UXVlcnlQYXJhbShsb2NhdGlvbi5ocmVmLCAnYnVpbGRlci53Y1ZlcnNpb24nKSB8fCBBTkdVTEFSX0xBVEVTVF9WRVJTSU9OO1xuICAgIHNjcmlwdC5pZCA9IFNDUklQVF9JRDtcbiAgICAvLyBUT0RPOiBkZXRlY3QgYnVpbGRlci53Y1ZlcnNpb24gYW5kIGlmIGN1c3RvbUVsZWVtbnRzIGV4aXN0cyBhbmQgZG9cbiAgICAvLyBkeW5hbWljIHZlcnNpb25zIGFuZCBsaXRlIGhlcmVcbiAgICBzY3JpcHQuc3JjID0gYGh0dHBzOi8vY2RuLmJ1aWxkZXIuaW8vanMvd2ViY29tcG9uZW50c0Ake1xuICAgICAgd2NWZXJzaW9uIHx8ICdsYXRlc3QnXG4gICAgfS9kaXN0L3N5c3RlbS9hbmd1bGFyL2J1aWxkZXItd2ViY29tcG9uZW50cy1hc3luYy5qc2A7XG4gICAgc2NyaXB0LmFzeW5jID0gdHJ1ZTtcbiAgICB3Y1NjcmlwdEluc2VydGVkID0gdHJ1ZTtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgc2NyaXB0LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCByZXNvbHZlKTtcbiAgICAgIHNjcmlwdC5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsIChlKSA9PiByZWplY3QoZS5lcnJvcikpO1xuICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzY3JpcHQpO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZW5zdXJlV2NMb2FkZWRBbmRVcGRhdGUoKSB7XG4gICAgYXdhaXQgdGhpcy5lbnN1cmVXQ1NjcmlwdExvYWRlZCgpO1xuICAgIGNvbnN0IHsgb25CdWlsZGVyV2NMb2FkIH0gPSB3aW5kb3cgYXMgYW55O1xuICAgIGlmIChvbkJ1aWxkZXJXY0xvYWQpIHtcbiAgICAgIG9uQnVpbGRlcldjTG9hZCgoQnVpbGRlcldDOiBhbnkpID0+IHtcbiAgICAgICAgY29uc3QgYnVpbGRlciA9IEJ1aWxkZXJXQy5idWlsZGVyIGFzIEJ1aWxkZXI7XG4gICAgICAgIGJ1aWxkZXIuYXBpS2V5ID0gdGhpcy5idWlsZGVyU2VydmljZS5hcGlLZXk7XG4gICAgICAgIGJ1aWxkZXIuY2FuVHJhY2sgPSB0aGlzLmJ1aWxkZXJTZXJ2aWNlLmNhblRyYWNrO1xuICAgICAgICBidWlsZGVyLnNldFVzZXJBdHRyaWJ1dGVzKG9taXQodGhpcy5idWlsZGVyU2VydmljZS5nZXRVc2VyQXR0cmlidXRlcygpLCAndXJsUGF0aCcpKTtcbiAgICAgICAgdGhpcy5idWlsZGVyU2VydmljZS51c2VyQXR0cmlidXRlc0NoYW5nZWQuc3Vic2NyaWJlKChhdHRycykgPT5cbiAgICAgICAgICBidWlsZGVyLnNldFVzZXJBdHRyaWJ1dGVzKGF0dHJzKVxuICAgICAgICApO1xuICAgICAgICB0aGlzLnRyaWdnZXJzdGF0ZUNoYW5nZSgpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgaWYgKHRoaXMucm91dGVyICYmIHRoaXMucmVsb2FkT25Sb3V0ZSkge1xuICAgICAgLy8gVE9ETzogc2hvdWxkIHRoZSBpbm5lciBmdW5jdGlvbiByZXR1cm4gcmVsb2FkT25Sb3V0ZT9cbiAgICAgIHRoaXMucm91dGVyLnJvdXRlUmV1c2VTdHJhdGVneS5zaG91bGRSZXVzZVJvdXRlID0gKCkgPT4gZmFsc2U7XG4gICAgfVxuXG4gICAgaWYgKEJ1aWxkZXIuaXNCcm93c2VyKSB7XG4gICAgICBpZiAodGhpcy5yb3V0ZXIpIHtcbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZChcbiAgICAgICAgICB0aGlzLnJvdXRlci5ldmVudHMuc3Vic2NyaWJlKChldmVudCkgPT4ge1xuICAgICAgICAgICAgaWYgKGV2ZW50IGluc3RhbmNlb2YgTmF2aWdhdGlvbkVuZCkge1xuICAgICAgICAgICAgICBpZiAodGhpcy5yZWxvYWRPblJvdXRlKSB7XG4gICAgICAgICAgICAgICAgLy8gRm9yY2UgcmVsb2FkIGNvbXBvbmVudFxuICAgICAgICAgICAgICAgIHRoaXMudmlzaWJsZS5uZXh0KGZhbHNlKTtcbiAgICAgICAgICAgICAgICBCdWlsZGVyLm5leHRUaWNrKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgIHRoaXMudmlzaWJsZS5uZXh0KHRydWUpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5hZGQoXG4gICAgICAgIHRoaXMubG9hZC5zdWJzY3JpYmUoYXN5bmMgKHZhbHVlOiBhbnkpID0+IHtcbiAgICAgICAgICAvLyBUT0RPOiB0aGlzIG1heSBydW4gY29uc3RhbnRseSB3aGVuIGVkaXRpbmcgLSBjaGVjayBvbiB0aGlzLCBub3RcbiAgICAgICAgICAvLyBlbmQgb2Ygd29ybGQgYnV0IG5vdCBpZGVhbCBmb3IgcGVyZlxuICAgICAgICAgIHRoaXMudmlld0NvbnRhaW5lci5kZXRhY2goKTtcbiAgICAgICAgICBpZiAoQnVpbGRlci5pc0VkaXRpbmcgfHwgKHZhbHVlICYmIHZhbHVlLmRhdGEgJiYgdGhpcy5oeWRyYXRlICE9PSBmYWxzZSkpIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuZW5zdXJlV2NMb2FkZWRBbmRVcGRhdGUoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChCdWlsZGVyLmlzQnJvd3NlciAmJiAodGhpcy5oeWRyYXRlICE9PSBmYWxzZSB8fCBCdWlsZGVyLmlzRWRpdGluZykpIHtcbiAgICAgIHRoaXMuZW5zdXJlV2NMb2FkZWRBbmRVcGRhdGUoKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyB0cmlnZ2Vyc3RhdGVDaGFuZ2UoKSB7XG4gICAgY29uc3QgcXVlcnkgPSBgYnVpbGRlci1jb21wb25lbnQtZWxlbWVudFtuYW1lPVwiJHt0aGlzLm1vZGVsfVwiXWA7XG4gICAgY29uc3QgZWxlbWVudDogYW55ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihxdWVyeSk7XG4gICAgaWYgKGVsZW1lbnQpIHtcbiAgICAgIGN1c3RvbUVsZW1lbnRzLndoZW5EZWZpbmVkKCdidWlsZGVyLWNvbXBvbmVudC1lbGVtZW50JykudGhlbigoKSA9PiB7XG4gICAgICAgIGVsZW1lbnQuc2V0U3RhdGUodGhpcy5kYXRhKTtcbiAgICAgICAgZWxlbWVudC5zZXRDb250ZXh0KHRoaXMuY29udGV4dCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgaWYgKGNoYW5nZXMuZGF0YSkge1xuICAgICAgdGhpcy50cmlnZ2Vyc3RhdGVDaGFuZ2UoKTtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMudW5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIC8vIFRPRE86IHRoaXMgc2hvdWxkIGJlIGluIEJ1aWxkZXJCbG9ja3NcbiAgYXN5bmMgb25DbGljayhldmVudDogTW91c2VFdmVudCkge1xuICAgIGlmICghdGhpcy5oYW5kbGVSb3V0aW5nKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKGV2ZW50LmJ1dHRvbiAhPT0gMCB8fCBldmVudC5jdHJsS2V5IHx8IGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQpIHtcbiAgICAgIC8vIElmIHRoaXMgaXMgYSBub24tbGVmdCBjbGljaywgb3IgdGhlIHVzZXIgaXMgaG9sZGluZyBjdHIvY21kLCBvciB0aGUgdXJsIGlzIGFic29sdXRlLFxuICAgICAgLy8gb3IgaWYgdGhlIGxpbmsgaGFzIGEgdGFyZ2V0IGF0dHJpYnV0ZSwgZG9uJ3Qgcm91dGUgb24gdGhlIGNsaWVudCBhbmQgbGV0IHRoZSBkZWZhdWx0XG4gICAgICAvLyBocmVmIHByb3BlcnR5IGhhbmRsZSB0aGUgbmF2aWdhdGlvblxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGhyZWZUYXJnZXQgPSB0aGlzLmZpbmRIcmVmVGFyZ2V0KGV2ZW50KTtcbiAgICBpZiAoIWhyZWZUYXJnZXQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyB0YXJnZXQ9XCJfYmxhbmtcIiBvciB0YXJnZXQ9XCJfc2VsZlwiIGV0Y1xuICAgIGlmIChocmVmVGFyZ2V0LnRhcmdldCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCBocmVmID0gaHJlZlRhcmdldC5nZXRBdHRyaWJ1dGUoJ2hyZWYnKTtcbiAgICBpZiAoIWhyZWYpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoaHJlZi5zdGFydHNXaXRoKCdqYXZhc2NyaXB0OicpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3Qgcm91dGVFdmVudDogUm91dGVFdmVudCA9IHtcbiAgICAgIHVybDogaHJlZixcbiAgICAgIGFuY2hvck5vZGU6IGhyZWZUYXJnZXQsXG4gICAgICBwcmV2ZW50RGVmYXVsdCgpIHtcbiAgICAgICAgdGhpcy5kZWZhdWx0UHJldmVudGVkID0gdHJ1ZTtcbiAgICAgIH0sXG4gICAgICBkZWZhdWx0UHJldmVudGVkOiBmYWxzZSxcbiAgICB9O1xuICAgIHRoaXMucm91dGUubmV4dChyb3V0ZUV2ZW50KTtcblxuICAgIGlmIChyb3V0ZUV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQpIHtcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKGV2ZW50Lm1ldGFLZXkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuaXNSZWxhdGl2ZShocmVmKSkge1xuICAgICAgY29uc3QgY29udmVydGVkID0gdGhpcy5jb252ZXJ0VG9SZWxhdGl2ZShocmVmKTtcbiAgICAgIGlmIChjb252ZXJ0ZWQpIHtcbiAgICAgICAgaHJlZiA9IGNvbnZlcnRlZDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIXRoaXMucm91dGVyKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gT3RoZXJ3aXNlIGlmIHRoaXMgdXJsIGlzIHJlbGF0aXZlLCBuYXZpZ2F0ZSBvbiB0aGUgY2xpZW50XG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcblxuICAgIC8vIEF0dGVtcHQgdG8gcm91dGUgb24gdGhlIGNsaWVudFxuICAgIGxldCBzdWNjZXNzOiBib29sZWFuIHwgbnVsbCA9IG51bGw7XG4gICAgY29uc3Qgcm91dGVQcm9taXNlID0gdGhpcy5yb3V0ZXIubmF2aWdhdGVCeVVybChocmVmKTtcblxuICAgIGNvbnN0IHVzZU5hdmlnYXRpb25UaW1lb3V0ID0gIShcbiAgICAgIHR5cGVvZiB0aGlzLm5hdmlnYXRpb25UaW1lb3V0ID09PSAnYm9vbGVhbicgJiYgIXRoaXMubmF2aWdhdGlvblRpbWVvdXRcbiAgICApO1xuICAgIGNvbnN0IHRpbWVvdXRQcm9taXNlID0gZGVsYXkoXG4gICAgICB0eXBlb2YgdGhpcy5uYXZpZ2F0aW9uVGltZW91dCA9PT0gJ251bWJlcidcbiAgICAgICAgPyB0aGlzLm5hdmlnYXRpb25UaW1lb3V0XG4gICAgICAgIDogTkFWSUdBVElPTl9USU1FT1VUX0RFRkFVTFQsXG4gICAgICBmYWxzZVxuICAgICk7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcHJvbWlzZVJhY2UgPSB1c2VOYXZpZ2F0aW9uVGltZW91dCA/IFt0aW1lb3V0UHJvbWlzZSwgcm91dGVQcm9taXNlXSA6IFtyb3V0ZVByb21pc2VdO1xuICAgICAgc3VjY2VzcyA9IGF3YWl0IFByb21pc2UucmFjZShwcm9taXNlUmFjZSk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIC8vIFRoaXMgaXMgaW4gYSBjbGljayBoYW5kbGVyIHNvIGl0IHdpbGwgb25seSBydW4gb24gdGhlIGNsaWVudFxuICAgICAgaWYgKHN1Y2Nlc3MpIHtcbiAgICAgICAgLy8gSWYgc3VjY2Vzc2Z1bCBzY3JvbGwgdGhlIHdpbmRvdyB0byB0aGUgdG9wXG4gICAgICAgIHdpbmRvdy5zY3JvbGxUbygwLCAwKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIE90aGVyd2lzZSBoYW5kbGUgdGhlIHJvdXRpbmcgd2l0aCBhIHBhZ2UgcmVmcmVzaCBvbiBmYWlsdXJlLiBBbmd1bGFyLCBieSBkZWFmdWx0XG4gICAgICAgIC8vIGlmIGl0IGZhaWxzIHRvIGxvYWQgYSBVUkwgKGUuZy4gaWYgYW4gQVBJIHJlcXVlc3QgZmFpbGVkIHdoZW4gbG9hZGluZyBpdCksIGluc3RlYWRcbiAgICAgICAgLy8gb2YgbmF2aWdhdGluZyB0byB0aGUgbmV3IHBhZ2UgdG8gdGVsbCB0aGUgdXNlciB0aGF0IHRoZWlyIGNsaWNrIGRpZCBzb21ldGhpbmcgYnV0XG4gICAgICAgIC8vIHRoZSByZXN1bHRpbmcgcGFnZSBoYXMgYW4gaXNzdWUsIGl0IGluc3RlYWQganVzdCBzaWxlbnRseSBmYWlscyBhbmQgc2hvd3MgdGhlIHVzZXJcbiAgICAgICAgLy8gbm90aGluZy4gTGV0cyBtYWtlIHN1cmUgd2Ugcm91dGUgdG8gdGhlIG5ldyBwYWdlLiBJbiBzb21lIGNhc2VzIHRoaXMgZXZlbiBicmluZ3MgdGhlXG4gICAgICAgIC8vIHVzZXIgdG8gYSBjb3JyZWN0IGFuZCB2YWxpZCBwYWdlIGFueXdheVxuICAgICAgICBsb2NhdGlvbi5ocmVmID0gYCR7bG9jYXRpb24ucHJvdG9jb2x9Ly8ke2xvY2F0aW9uLmhvc3R9JHtocmVmfWA7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpc1JlbGF0aXZlKGhyZWY6IHN0cmluZykge1xuICAgIHJldHVybiAoXG4gICAgICAhaHJlZi5tYXRjaCgvXihcXC9cXC98aHR0cHM/OlxcL1xcLykvaSkgJiZcbiAgICAgIC8vIEhhbmRsZSBNYWlsdG8gYW5kIFRlbCBsaW5rc1xuICAgICAgIWhyZWYuc3RhcnRzV2l0aCgndGVsOicpICYmXG4gICAgICAhaHJlZi5zdGFydHNXaXRoKCdtYWlsdG86JykgJiZcbiAgICAgIC8vIEhhbmRsZSBsb2NhbCBoYXNoIGxpbmtzXG4gICAgICAhaHJlZi5zdGFydHNXaXRoKCcjJylcbiAgICApO1xuICB9XG5cbiAgLy8gQXR0ZW1wdCB0byBjb252ZXJ0IGFuIGFic29sdXRlIHVybCB0byByZWxhdGl2ZSBpZiBwb3NzaWJsZSAoYWthIGlmIHRoZSBob3N0cyBtYXRjaClcbiAgcHJpdmF0ZSBjb252ZXJ0VG9SZWxhdGl2ZShocmVmOiBzdHJpbmcpIHtcbiAgICBjb25zdCBjdXJyZW50VXJsID0gbmV3IFVSTChsb2NhdGlvbi5ocmVmKTtcbiAgICBjb25zdCBocmVmVXJsID0gbmV3IFVSTChocmVmKTtcblxuICAgIGlmIChjdXJyZW50VXJsLmhvc3QgPT09IGhyZWZVcmwuaG9zdCkge1xuICAgICAgY29uc3QgcmVsYXRpdmVVcmwgPSBocmVmVXJsLnBhdGhuYW1lICsgKGhyZWZVcmwuc2VhcmNoID8gaHJlZlVybC5zZWFyY2ggOiAnJyk7XG4gICAgICByZXR1cm4gcmVsYXRpdmVVcmw7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBmaW5kSHJlZlRhcmdldChldmVudDogTW91c2VFdmVudCk6IEhUTUxBbmNob3JFbGVtZW50IHwgbnVsbCB7XG4gICAgbGV0IGVsZW1lbnQgPSBldmVudC50YXJnZXQgYXMgSFRNTEVsZW1lbnQgfCBudWxsO1xuXG4gICAgd2hpbGUgKGVsZW1lbnQpIHtcbiAgICAgIGlmIChlbGVtZW50IGluc3RhbmNlb2YgSFRNTEFuY2hvckVsZW1lbnQgJiYgZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2hyZWYnKSkge1xuICAgICAgICByZXR1cm4gZWxlbWVudDtcbiAgICAgIH1cblxuICAgICAgaWYgKGVsZW1lbnQgPT09IGV2ZW50LmN1cnJlbnRUYXJnZXQpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG5cbiAgICAgIGVsZW1lbnQgPSBlbGVtZW50LnBhcmVudEVsZW1lbnQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn1cbiIsIjxzcGFuICpuZ0lmPVwidmlzaWJsZSB8IGFzeW5jXCIgY2xhc3M9XCJidWlsZGVyLWNvbXBvbmVudC13cmFwXCI+XG4gIDxzcGFuICpuZ0lmPVwiIXByZXJlbmRlclwiPlxuICAgIDxidWlsZGVyLWJsb2Nrc1xuICAgICAgZmllbGQ9XCJibG9ja3NcIlxuICAgICAgW2tleV09XCJrZXlcIlxuICAgICAgW21vZGVsXT1cIm1vZGVsXCJcbiAgICAgIChjbGljayk9XCJvbkNsaWNrKCRldmVudClcIlxuICAgICAgW3ByZXJlbmRlcl09XCJmYWxzZVwiXG4gICAgICBbb3B0aW9uc109XCJvcHRpb25zXCJcbiAgICA+PC9idWlsZGVyLWJsb2Nrcz5cbiAgPC9zcGFuPlxuICA8c3BhbiAqbmdJZj1cInByZXJlbmRlclwiPlxuICAgIDxidWlsZGVyLWNvbnRlbnRcbiAgICAgIFtkYXRhXT1cImRhdGFcIlxuICAgICAgW2h5ZHJhdGVdPVwiaHlkcmF0ZVwiXG4gICAgICBbcHJlcmVuZGVyXT1cInByZXJlbmRlclwiXG4gICAgICBbY29udGVudF09XCJjb250ZW50XCJcbiAgICAgIFtvcHRpb25zXT1cIm9wdGlvbnNcIlxuICAgICAgKGNsaWNrKT1cIm9uQ2xpY2soJGV2ZW50KVwiXG4gICAgICAoY29udGVudExvYWQpPVwibG9hZC5uZXh0KCRldmVudClcIlxuICAgICAgKGNvbnRlbnRFcnJvcik9XCJlcnJvci5uZXh0KCRldmVudClcIlxuICAgICAgKmJ1aWxkZXJNb2RlbD1cIm1vZGVsOyBsZXQgY29udGVudDsgbGV0IGxvYWRpbmcgPSBsb2FkaW5nOyBsZXQgbWV0YSA9IG1ldGE7XCJcbiAgICA+XG4gICAgICA8YnVpbGRlci1ibG9ja3NcbiAgICAgICAgKm5nSWY9XCJjb250ZW50XCJcbiAgICAgICAgZmllbGQ9XCJibG9ja3NcIlxuICAgICAgICBba2V5XT1cImtleVwiXG4gICAgICAgIFttb2RlbF09XCJtb2RlbFwiXG4gICAgICAgIFtwcmVyZW5kZXJdPVwicHJlcmVuZGVyXCJcbiAgICAgICAgW29wdGlvbnNdPVwib3B0aW9uc1wiXG4gICAgICAgIFtibG9ja3NdPVwiY29udGVudC5ibG9ja3MgfHwgY29udGVudFwiXG4gICAgICAgIFticmVha3BvaW50c109XCIoY29udGVudC5tZXRhICYmIGNvbnRlbnQubWV0YS5icmVha3BvaW50cykgfHwgKG1ldGEgJiYgbWV0YS5icmVha3BvaW50cykgfHwgdW5kZWZpbmVkXCJcbiAgICAgID48L2J1aWxkZXItYmxvY2tzPlxuICAgICAgPG5nLWNvbnRlbnQgKm5nSWY9XCJsb2FkaW5nXCI+PC9uZy1jb250ZW50PlxuICAgIDwvYnVpbGRlci1jb250ZW50PlxuICA8L3NwYW4+XG48L3NwYW4+XG4iXX0=