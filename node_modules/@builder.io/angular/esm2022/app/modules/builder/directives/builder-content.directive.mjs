import { Directive, Input, makeStateKey, Optional } from '@angular/core';
import { NavigationEnd } from '@angular/router';
import { Builder } from '@builder.io/sdk';
import { Subscription } from 'rxjs';
import { BuilderContentService } from '../services/builder-content.service';
import * as i0 from "@angular/core";
import * as i1 from "../services/builder.service";
import * as i2 from "../components/builder-component/builder-component.service";
import * as i3 from "@angular/router";
export class BuilderContentDirective {
    _viewContainer;
    renderer;
    builder;
    builderComponentService;
    transferState;
    router;
    get component() {
        // return BuilderService.componentInstances[this._context.model as string];
        return this.builderComponentService.contentComponentInstance;
    }
    lastContentId = null;
    lastUrl = null;
    subscriptions = new Subscription();
    _context = new BuilderContentContext();
    _templateRef = null;
    _viewRef = null;
    // private _repeat = false;
    match;
    matchId = '';
    clickTracked = false;
    hydrated = false;
    constructor(_viewContainer, renderer, builder, builderComponentService, transferState, templateRef, router) {
        this._viewContainer = _viewContainer;
        this.renderer = renderer;
        this.builder = builder;
        this.builderComponentService = builderComponentService;
        this.transferState = transferState;
        this.router = router;
        builderComponentService.contentDirectiveInstance = this;
        this._templateRef = templateRef;
    }
    // TODO: pass this option down from builder-component
    reloadOnRoute = true;
    contentSubscription = null;
    stateKey;
    requesting = true;
    reset() {
        // TODO: listen to any target change? This just updates target?
        // TODO: track last fetched ID and don't replace dom if on new url the content is the same...
        this.clickTracked = false;
        this.hydrated = false;
        // Verify the route didn't result in this component being destroyed
        this.request();
    }
    ngOnInit() {
        Builder.nextTick(() => {
            this.request();
        });
        if (this.router) {
            this.subscriptions.add(this.router.events.subscribe((event) => {
                // TODO: this doesn't trigger
                if (event instanceof NavigationEnd) {
                    if (this.reloadOnRoute) {
                        const viewRef = this._viewRef;
                        if (viewRef && viewRef.destroyed) {
                            return;
                        }
                        if (this.url !== this.lastUrl) {
                            this.reset();
                        }
                    }
                }
            }));
        }
    }
    ngOnDestroy() {
        this.subscriptions.unsubscribe();
        if (this.contentSubscription) {
            this.contentSubscription.unsubscribe();
        }
    }
    // TODO: have another option for this or get from metadata
    // @Input()
    // set modelMultiple(repeat: boolean) {
    //   this._repeat = repeat;
    // }
    // @HostListener('click')
    onClick(event) {
        if (this.matchId && !this.hydrated) {
            const match = this.match;
            if (this.builder.autoTrack) {
                this.builder.trackInteraction(this.matchId, match && match.variationId, this.clickTracked, event, { content: match });
            }
            this.clickTracked = true;
        }
        // TODO: only in editor mode
        // TODO: put messaging on builder class
        if (document.body.classList.contains('builder-editing')) {
            if (this.matchId) {
                // TODO: get event object and pass mouse coordinages
                window.parent.postMessage({
                    type: 'builder.clickContent',
                    data: {
                        id: this.matchId,
                        model: this._context.model,
                    },
                }, '*');
            }
            else {
                window.parent.postMessage({
                    type: 'builder.clickModel',
                    data: {
                        model: this._context.model,
                    },
                }, '*');
            }
        }
    }
    get stateKeyString() {
        return 'builder:' + this._context.model + ':' + (this.reloadOnRoute ? this.url : '');
    }
    // TODO: limit?
    // TODO: context with index, etc
    set builderModel(model) {
        if (!model) {
            return;
        }
        this._context.model = model;
        this._updateView();
        this.stateKey = makeStateKey(this.stateKeyString);
        // this.request();
        const rootNode = this._viewRef.rootNodes[0];
        this.renderer.setAttribute(rootNode, 'builder-model', model);
        this.renderer.setAttribute(rootNode, 'builder-model-name', model.replace(/-/g, ' '));
        this.renderer.listen(rootNode, 'click', (event) => this.onClick(event));
    }
    get url() {
        const location = this.builder.getLocation();
        return location.pathname || ''; // + (location.search || '');
    }
    // TODO: service for this
    request() {
        this.lastUrl = this.url;
        this.requesting = true;
        if (this.component && !this.component.prerender) {
            return;
        }
        const viewRef = this._viewRef;
        if (viewRef && viewRef.destroyed) {
            return;
        }
        let receivedFirstResponse = false;
        const model = this._context.model;
        const options = this.component && this.component.options;
        const initialContent = (this.component && this.component.content) ||
            (Builder.isBrowser &&
                // firstEverLoad &&
                this.transferState &&
                this.transferState.get(this.stateKeyString, null));
        // firstEverLoad = false;
        // TODO: if not multipe
        if (this.contentSubscription) {
            // TODO: cancel a request if one is pending... or set some kind of flag
            this.contentSubscription.unsubscribe();
        }
        const hydrate = Builder.isBrowser && this.component && this.component.hydrate;
        const key = Builder.isEditing || !this.reloadOnRoute ? model : `${model}:${this.url}`;
        const subscription = (this.contentSubscription = this.builder
            .queueGetContent(model, {
            initialContent,
            key,
            ...options,
            prerender: true,
            static: !hydrate,
        })
            .subscribe((result) => {
            let match = result[0];
            // Cancel handling request if new one created or they have been canceled, to avoid race conditions
            // if multiple routes or other events happen
            if (this.contentSubscription !== subscription) {
                if (!receivedFirstResponse) {
                }
                return;
            }
            if (match && match.id === this.lastContentId) {
                return;
            }
            this.lastContentId = match && match.id;
            if (this.transferState && !Builder.isBrowser) {
                this.transferState.set(this.stateKeyString, result);
            }
            // tslint:disable-next-line:no-non-null-assertion
            const viewRef = this._viewRef;
            if (viewRef.destroyed) {
                this.subscriptions.unsubscribe();
                if (this.contentSubscription) {
                    this.contentSubscription.unsubscribe();
                }
                return;
            }
            const rootNode = Builder.isBrowser && viewRef.rootNodes[0];
            if (Builder.isBrowser) {
                if (rootNode) {
                    if (rootNode && rootNode.classList.contains('builder-editor-injected')) {
                        viewRef.detach();
                        return;
                    }
                }
            }
            // FIXME: nasty hack to detect secondary updates vs original. Build proper support into JS SDK
            // if (this._context.loading || result.length > viewRef.context.results.length) {
            this._context.loading = false;
            const search = this.builder.getLocation().search || '';
            // TODO: how handle singleton vs multiple
            if (!match && search.includes('builder.preview=' + this._context.model)) {
                match = {
                    id: 'preview',
                    name: 'Preview',
                    data: {},
                };
            }
            if (this.component) {
                this.component.contentLoad.next(match);
            }
            else {
                console.warn('No component!');
            }
            if (match) {
                const rootNode = this._viewRef.rootNodes[0];
                this.matchId = match.id;
                this.renderer.setAttribute(rootNode, 'builder-content-entry-id', match.id);
                this.match = match;
                viewRef.context.$implicit = match.data;
                viewRef.context.meta = match.meta;
                // viewRef.context.results = result.map(item => ({ ...item.data, $id: item.id }));
                if (!hydrate && this.builder.autoTrack) {
                    this.builder.trackImpression(match.id, match.variationId, undefined, {
                        content: match,
                    });
                }
            }
            if (!viewRef.destroyed) {
                viewRef.detectChanges();
                if (this.builderComponentService.contentComponentInstance &&
                    this.builderComponentService.contentComponentInstance.prerender &&
                    Builder.isBrowser &&
                    Builder.isStatic) {
                    Builder.nextTick(() => {
                        if (this.builderComponentService.contentComponentInstance) {
                            this.builderComponentService.contentComponentInstance.findAndRunScripts();
                        }
                    });
                }
                // TODO: it's possible we don't want anything below to run if this has been destroyed
                if (match && match.data && match.data.animations && Builder.isBrowser && !hydrate) {
                    Builder.nextTick(() => {
                        Builder.animator.bindAnimations(match.data.animations);
                    });
                }
            }
            if (!receivedFirstResponse) {
                receivedFirstResponse = true;
            }
        }, (error) => {
            if (this.component) {
                this.component.contentError.next(error);
            }
            else {
                console.warn('No component!');
            }
            if (!receivedFirstResponse) {
                // TODO: how to zone error
                receivedFirstResponse = true;
            }
        }));
    }
    _updateView() {
        if (this._context.model) {
            this._viewContainer.clear();
            if (this._templateRef) {
                this._viewRef = this._viewContainer.createEmbeddedView(this._templateRef, this._context);
            }
        }
    }
    static ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.0.6", ngImport: i0, type: BuilderContentDirective, deps: [{ token: i0.ViewContainerRef }, { token: i0.Renderer2 }, { token: i1.BuilderService }, { token: i2.BuilderComponentService }, { token: i0.TransferState, optional: true }, { token: i0.TemplateRef }, { token: i3.Router, optional: true }], target: i0.ɵɵFactoryTarget.Directive });
    static ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "18.0.6", type: BuilderContentDirective, selector: "[builderModel]", inputs: { reloadOnRoute: "reloadOnRoute", builderModel: "builderModel" }, providers: [BuilderContentService], ngImport: i0 });
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.0.6", ngImport: i0, type: BuilderContentDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[builderModel]',
                    providers: [BuilderContentService],
                }]
        }], ctorParameters: () => [{ type: i0.ViewContainerRef }, { type: i0.Renderer2 }, { type: i1.BuilderService }, { type: i2.BuilderComponentService }, { type: i0.TransferState, decorators: [{
                    type: Optional
                }] }, { type: i0.TemplateRef }, { type: i3.Router, decorators: [{
                    type: Optional
                }] }], propDecorators: { reloadOnRoute: [{
                type: Input
            }], builderModel: [{
                type: Input
            }] } });
export class BuilderContentContext {
    $implicit;
    match;
    model;
    loading = true;
    results = [];
    meta;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVpbGRlci1jb250ZW50LmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9hcHAvbW9kdWxlcy9idWlsZGVyL2RpcmVjdGl2ZXMvYnVpbGRlci1jb250ZW50LmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUVULEtBQUssRUFDTCxZQUFZLEVBR1osUUFBUSxFQU1ULE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxhQUFhLEVBQVUsTUFBTSxpQkFBaUIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsT0FBTyxFQUF1QyxNQUFNLGlCQUFpQixDQUFDO0FBQy9FLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFcEMsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0scUNBQXFDLENBQUM7Ozs7O0FBTzVFLE1BQU0sT0FBTyx1QkFBdUI7SUF3QnhCO0lBQ0E7SUFDQTtJQUNBO0lBQ1k7SUFFQTtJQTdCdEIsSUFBWSxTQUFTO1FBQ25CLDJFQUEyRTtRQUMzRSxPQUFPLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyx3QkFBd0IsQ0FBQztJQUMvRCxDQUFDO0lBRUQsYUFBYSxHQUFrQixJQUFJLENBQUM7SUFDcEMsT0FBTyxHQUFrQixJQUFJLENBQUM7SUFFdEIsYUFBYSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7SUFFbkMsUUFBUSxHQUEwQixJQUFJLHFCQUFxQixFQUFFLENBQUM7SUFDOUQsWUFBWSxHQUE4QyxJQUFJLENBQUM7SUFDL0QsUUFBUSxHQUFrRCxJQUFJLENBQUM7SUFDdkUsMkJBQTJCO0lBQ25CLEtBQUssQ0FBTTtJQUVYLE9BQU8sR0FBRyxFQUFFLENBQUM7SUFFYixZQUFZLEdBQUcsS0FBSyxDQUFDO0lBRTdCLFFBQVEsR0FBRyxLQUFLLENBQUM7SUFFakIsWUFDVSxjQUFnQyxFQUNoQyxRQUFtQixFQUNuQixPQUF1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QXFCLENBQUM7aUJBQ25DOzswQkE2QkksUUFBUTs7MEJBRVIsUUFBUTt5Q0FPRixhQUFhO3NCQUFyQixLQUFLO2dCQTZHRixZQUFZO3NCQURmLEtBQUs7O0FBK0xSLE1BQU0sT0FBTyxxQkFBcUI7SUFDaEMsU0FBUyxDQUFPO0lBQ2hCLEtBQUssQ0FBTztJQUNaLEtBQUssQ0FBVTtJQUNmLE9BQU8sR0FBRyxJQUFJLENBQUM7SUFDZixPQUFPLEdBQVUsRUFBRSxDQUFDO0lBQ3BCLElBQUksQ0FBTztDQUNaIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRGlyZWN0aXZlLFxuICBFbWJlZGRlZFZpZXdSZWYsXG4gIElucHV0LFxuICBtYWtlU3RhdGVLZXksXG4gIE9uRGVzdHJveSxcbiAgT25Jbml0LFxuICBPcHRpb25hbCxcbiAgUmVuZGVyZXIyLFxuICBTdGF0ZUtleSxcbiAgVGVtcGxhdGVSZWYsXG4gIFRyYW5zZmVyU3RhdGUsXG4gIFZpZXdDb250YWluZXJSZWZcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBOYXZpZ2F0aW9uRW5kLCBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgQnVpbGRlciwgU3Vic2NyaXB0aW9uIGFzIEJ1aWxkZXJTdWJzY3JpcHRpb24gfSBmcm9tICdAYnVpbGRlci5pby9zZGsnO1xuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBCdWlsZGVyQ29tcG9uZW50U2VydmljZSB9IGZyb20gJy4uL2NvbXBvbmVudHMvYnVpbGRlci1jb21wb25lbnQvYnVpbGRlci1jb21wb25lbnQuc2VydmljZSc7XG5pbXBvcnQgeyBCdWlsZGVyQ29udGVudFNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9idWlsZGVyLWNvbnRlbnQuc2VydmljZSc7XG5pbXBvcnQgeyBCdWlsZGVyU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2J1aWxkZXIuc2VydmljZSc7XG5cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ1tidWlsZGVyTW9kZWxdJyxcbiAgcHJvdmlkZXJzOiBbQnVpbGRlckNvbnRlbnRTZXJ2aWNlXSxcbn0pXG5leHBvcnQgY2xhc3MgQnVpbGRlckNvbnRlbnREaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XG4gIHByaXZhdGUgZ2V0IGNvbXBvbmVudCgpIHtcbiAgICAvLyByZXR1cm4gQnVpbGRlclNlcnZpY2UuY29tcG9uZW50SW5zdGFuY2VzW3RoaXMuX2NvbnRleHQubW9kZWwgYXMgc3RyaW5nXTtcbiAgICByZXR1cm4gdGhpcy5idWlsZGVyQ29tcG9uZW50U2VydmljZS5jb250ZW50Q29tcG9uZW50SW5zdGFuY2U7XG4gIH1cblxuICBsYXN0Q29udGVudElkOiBzdHJpbmcgfCBudWxsID0gbnVsbDtcbiAgbGFzdFVybDogc3RyaW5nIHwgbnVsbCA9IG51bGw7XG5cbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb25zID0gbmV3IFN1YnNjcmlwdGlvbigpO1xuXG4gIHByaXZhdGUgX2NvbnRleHQ6IEJ1aWxkZXJDb250ZW50Q29udGV4dCA9IG5ldyBCdWlsZGVyQ29udGVudENvbnRleHQoKTtcbiAgcHJpdmF0ZSBfdGVtcGxhdGVSZWY6IFRlbXBsYXRlUmVmPEJ1aWxkZXJDb250ZW50Q29udGV4dD4gfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBfdmlld1JlZjogRW1iZWRkZWRWaWV3UmVmPEJ1aWxkZXJDb250ZW50Q29udGV4dD4gfCBudWxsID0gbnVsbDtcbiAgLy8gcHJpdmF0ZSBfcmVwZWF0ID0gZmFsc2U7XG4gIHByaXZhdGUgbWF0Y2g6IGFueTtcblxuICBwcml2YXRlIG1hdGNoSWQgPSAnJztcblxuICBwcml2YXRlIGNsaWNrVHJhY2tlZCA9IGZhbHNlO1xuXG4gIGh5ZHJhdGVkID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBfdmlld0NvbnRhaW5lcjogVmlld0NvbnRhaW5lclJlZixcbiAgICBwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsXG4gICAgcHJpdmF0ZSBidWlsZGVyOiBCdWlsZGVyU2VydmljZSxcbiAgICBwcml2YXRlIGJ1aWxkZXJDb21wb25lbnRTZXJ2aWNlOiBCdWlsZGVyQ29tcG9uZW50U2VydmljZSxcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIHRyYW5zZmVyU3RhdGU6IFRyYW5zZmVyU3RhdGUsXG4gICAgdGVtcGxhdGVSZWY6IFRlbXBsYXRlUmVmPEJ1aWxkZXJDb250ZW50Q29udGV4dD4sXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSByb3V0ZXI/OiBSb3V0ZXJcbiAgKSB7XG4gICAgYnVpbGRlckNvbXBvbmVudFNlcnZpY2UuY29udGVudERpcmVjdGl2ZUluc3RhbmNlID0gdGhpcztcbiAgICB0aGlzLl90ZW1wbGF0ZVJlZiA9IHRlbXBsYXRlUmVmO1xuICB9XG5cbiAgLy8gVE9ETzogcGFzcyB0aGlzIG9wdGlvbiBkb3duIGZyb20gYnVpbGRlci1jb21wb25lbnRcbiAgQElucHV0KCkgcmVsb2FkT25Sb3V0ZSA9IHRydWU7XG5cbiAgY29udGVudFN1YnNjcmlwdGlvbjogQnVpbGRlclN1YnNjcmlwdGlvbiB8IG51bGwgPSBudWxsO1xuXG4gIHN0YXRlS2V5OiBTdGF0ZUtleTxhbnk+IHwgdW5kZWZpbmVkO1xuXG4gIHJlcXVlc3RpbmcgPSB0cnVlO1xuXG4gIHJlc2V0KCkge1xuICAgIC8vIFRPRE86IGxpc3RlbiB0byBhbnkgdGFyZ2V0IGNoYW5nZT8gVGhpcyBqdXN0IHVwZGF0ZXMgdGFyZ2V0P1xuXG4gICAgLy8gVE9ETzogdHJhY2sgbGFzdCBmZXRjaGVkIElEIGFuZCBkb24ndCByZXBsYWNlIGRvbSBpZiBvbiBuZXcgdXJsIHRoZSBjb250ZW50IGlzIHRoZSBzYW1lLi4uXG4gICAgdGhpcy5jbGlja1RyYWNrZWQgPSBmYWxzZTtcbiAgICB0aGlzLmh5ZHJhdGVkID0gZmFsc2U7XG4gICAgLy8gVmVyaWZ5IHRoZSByb3V0ZSBkaWRuJ3QgcmVzdWx0IGluIHRoaXMgY29tcG9uZW50IGJlaW5nIGRlc3Ryb3llZFxuICAgIHRoaXMucmVxdWVzdCgpO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgQnVpbGRlci5uZXh0VGljaygoKSA9PiB7XG4gICAgICB0aGlzLnJlcXVlc3QoKTtcbiAgICB9KTtcblxuICAgIGlmICh0aGlzLnJvdXRlcikge1xuICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZChcbiAgICAgICAgdGhpcy5yb3V0ZXIuZXZlbnRzLnN1YnNjcmliZSgoZXZlbnQpID0+IHtcbiAgICAgICAgICAvLyBUT0RPOiB0aGlzIGRvZXNuJ3QgdHJpZ2dlclxuICAgICAgICAgIGlmIChldmVudCBpbnN0YW5jZW9mIE5hdmlnYXRpb25FbmQpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnJlbG9hZE9uUm91dGUpIHtcbiAgICAgICAgICAgICAgY29uc3Qgdmlld1JlZiA9IHRoaXMuX3ZpZXdSZWY7XG4gICAgICAgICAgICAgIGlmICh2aWV3UmVmICYmIHZpZXdSZWYuZGVzdHJveWVkKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgaWYgKHRoaXMudXJsICE9PSB0aGlzLmxhc3RVcmwpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0KCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy51bnN1YnNjcmliZSgpO1xuICAgIGlmICh0aGlzLmNvbnRlbnRTdWJzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMuY29udGVudFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuXG4gIC8vIFRPRE86IGhhdmUgYW5vdGhlciBvcHRpb24gZm9yIHRoaXMgb3IgZ2V0IGZyb20gbWV0YWRhdGFcbiAgLy8gQElucHV0KClcbiAgLy8gc2V0IG1vZGVsTXVsdGlwbGUocmVwZWF0OiBib29sZWFuKSB7XG4gIC8vICAgdGhpcy5fcmVwZWF0ID0gcmVwZWF0O1xuICAvLyB9XG5cbiAgLy8gQEhvc3RMaXN0ZW5lcignY2xpY2snKVxuICBvbkNsaWNrKGV2ZW50OiBNb3VzZUV2ZW50KSB7XG4gICAgaWYgKHRoaXMubWF0Y2hJZCAmJiAhdGhpcy5oeWRyYXRlZCkge1xuICAgICAgY29uc3QgbWF0Y2ggPSB0aGlzLm1hdGNoO1xuICAgICAgaWYgKHRoaXMuYnVpbGRlci5hdXRvVHJhY2spIHtcbiAgICAgICAgdGhpcy5idWlsZGVyLnRyYWNrSW50ZXJhY3Rpb24oXG4gICAgICAgICAgdGhpcy5tYXRjaElkLFxuICAgICAgICAgIG1hdGNoICYmIG1hdGNoLnZhcmlhdGlvbklkLFxuICAgICAgICAgIHRoaXMuY2xpY2tUcmFja2VkLFxuICAgICAgICAgIGV2ZW50LFxuICAgICAgICAgIHsgY29udGVudDogbWF0Y2ggfVxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgdGhpcy5jbGlja1RyYWNrZWQgPSB0cnVlO1xuICAgIH1cblxuICAgIC8vIFRPRE86IG9ubHkgaW4gZWRpdG9yIG1vZGVcbiAgICAvLyBUT0RPOiBwdXQgbWVzc2FnaW5nIG9uIGJ1aWxkZXIgY2xhc3NcbiAgICBpZiAoZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuY29udGFpbnMoJ2J1aWxkZXItZWRpdGluZycpKSB7XG4gICAgICBpZiAodGhpcy5tYXRjaElkKSB7XG4gICAgICAgIC8vIFRPRE86IGdldCBldmVudCBvYmplY3QgYW5kIHBhc3MgbW91c2UgY29vcmRpbmFnZXNcbiAgICAgICAgd2luZG93LnBhcmVudC5wb3N0TWVzc2FnZShcbiAgICAgICAgICB7XG4gICAgICAgICAgICB0eXBlOiAnYnVpbGRlci5jbGlja0NvbnRlbnQnLFxuICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICBpZDogdGhpcy5tYXRjaElkLFxuICAgICAgICAgICAgICBtb2RlbDogdGhpcy5fY29udGV4dC5tb2RlbCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICAnKidcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHdpbmRvdy5wYXJlbnQucG9zdE1lc3NhZ2UoXG4gICAgICAgICAge1xuICAgICAgICAgICAgdHlwZTogJ2J1aWxkZXIuY2xpY2tNb2RlbCcsXG4gICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgIG1vZGVsOiB0aGlzLl9jb250ZXh0Lm1vZGVsLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgICcqJ1xuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGdldCBzdGF0ZUtleVN0cmluZygpIHtcbiAgICByZXR1cm4gJ2J1aWxkZXI6JyArIHRoaXMuX2NvbnRleHQubW9kZWwgKyAnOicgKyAodGhpcy5yZWxvYWRPblJvdXRlID8gdGhpcy51cmwgOiAnJyk7XG4gIH1cblxuICAvLyBUT0RPOiBsaW1pdD9cbiAgLy8gVE9ETzogY29udGV4dCB3aXRoIGluZGV4LCBldGNcbiAgQElucHV0KClcbiAgc2V0IGJ1aWxkZXJNb2RlbChtb2RlbDogc3RyaW5nKSB7XG4gICAgaWYgKCFtb2RlbCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl9jb250ZXh0Lm1vZGVsID0gbW9kZWw7XG4gICAgdGhpcy5fdXBkYXRlVmlldygpO1xuICAgIHRoaXMuc3RhdGVLZXkgPSBtYWtlU3RhdGVLZXkodGhpcy5zdGF0ZUtleVN0cmluZyk7XG4gICAgLy8gdGhpcy5yZXF1ZXN0KCk7XG4gICAgY29uc3Qgcm9vdE5vZGUgPSB0aGlzLl92aWV3UmVmIS5yb290Tm9kZXNbMF07XG4gICAgdGhpcy5yZW5kZXJlci5zZXRBdHRyaWJ1dGUocm9vdE5vZGUsICdidWlsZGVyLW1vZGVsJywgbW9kZWwpO1xuICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKHJvb3ROb2RlLCAnYnVpbGRlci1tb2RlbC1uYW1lJywgbW9kZWwucmVwbGFjZSgvLS9nLCAnICcpKTtcbiAgICB0aGlzLnJlbmRlcmVyLmxpc3Rlbihyb290Tm9kZSwgJ2NsaWNrJywgKGV2ZW50OiBNb3VzZUV2ZW50KSA9PiB0aGlzLm9uQ2xpY2soZXZlbnQpKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IHVybCgpIHtcbiAgICBjb25zdCBsb2NhdGlvbiA9IHRoaXMuYnVpbGRlci5nZXRMb2NhdGlvbigpO1xuICAgIHJldHVybiBsb2NhdGlvbi5wYXRobmFtZSB8fCAnJzsgLy8gKyAobG9jYXRpb24uc2VhcmNoIHx8ICcnKTtcbiAgfVxuXG4gIC8vIFRPRE86IHNlcnZpY2UgZm9yIHRoaXNcbiAgcmVxdWVzdCgpIHtcbiAgICB0aGlzLmxhc3RVcmwgPSB0aGlzLnVybDtcbiAgICB0aGlzLnJlcXVlc3RpbmcgPSB0cnVlO1xuXG4gICAgaWYgKHRoaXMuY29tcG9uZW50ICYmICF0aGlzLmNvbXBvbmVudC5wcmVyZW5kZXIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB2aWV3UmVmID0gdGhpcy5fdmlld1JlZjtcbiAgICBpZiAodmlld1JlZiAmJiB2aWV3UmVmLmRlc3Ryb3llZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCByZWNlaXZlZEZpcnN0UmVzcG9uc2UgPSBmYWxzZTtcbiAgICBjb25zdCBtb2RlbCA9IHRoaXMuX2NvbnRleHQubW9kZWwgYXMgc3RyaW5nO1xuXG4gICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMuY29tcG9uZW50ICYmIHRoaXMuY29tcG9uZW50Lm9wdGlvbnM7XG5cbiAgICBjb25zdCBpbml0aWFsQ29udGVudCA9XG4gICAgICAodGhpcy5jb21wb25lbnQgJiYgdGhpcy5jb21wb25lbnQuY29udGVudCkgfHxcbiAgICAgIChCdWlsZGVyLmlzQnJvd3NlciAmJlxuICAgICAgICAvLyBmaXJzdEV2ZXJMb2FkICYmXG4gICAgICAgIHRoaXMudHJhbnNmZXJTdGF0ZSAmJlxuICAgICAgICB0aGlzLnRyYW5zZmVyU3RhdGUuZ2V0KHRoaXMuc3RhdGVLZXlTdHJpbmcgYXMgYW55LCBudWxsIGFzIGFueSkpO1xuXG4gICAgLy8gZmlyc3RFdmVyTG9hZCA9IGZhbHNlO1xuXG4gICAgLy8gVE9ETzogaWYgbm90IG11bHRpcGVcblxuICAgIGlmICh0aGlzLmNvbnRlbnRTdWJzY3JpcHRpb24pIHtcbiAgICAgIC8vIFRPRE86IGNhbmNlbCBhIHJlcXVlc3QgaWYgb25lIGlzIHBlbmRpbmcuLi4gb3Igc2V0IHNvbWUga2luZCBvZiBmbGFnXG4gICAgICB0aGlzLmNvbnRlbnRTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB9XG5cbiAgICBjb25zdCBoeWRyYXRlID0gQnVpbGRlci5pc0Jyb3dzZXIgJiYgdGhpcy5jb21wb25lbnQgJiYgdGhpcy5jb21wb25lbnQuaHlkcmF0ZTtcblxuICAgIGNvbnN0IGtleSA9IEJ1aWxkZXIuaXNFZGl0aW5nIHx8ICF0aGlzLnJlbG9hZE9uUm91dGUgPyBtb2RlbCA6IGAke21vZGVsfToke3RoaXMudXJsfWA7XG4gICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gKHRoaXMuY29udGVudFN1YnNjcmlwdGlvbiA9IHRoaXMuYnVpbGRlclxuICAgICAgLnF1ZXVlR2V0Q29udGVudChtb2RlbCwge1xuICAgICAgICBpbml0aWFsQ29udGVudCxcbiAgICAgICAga2V5LFxuICAgICAgICAuLi5vcHRpb25zLFxuICAgICAgICBwcmVyZW5kZXI6IHRydWUsXG4gICAgICAgIHN0YXRpYzogIWh5ZHJhdGUsXG4gICAgICB9KVxuICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgKHJlc3VsdDogYW55W10pID0+IHtcbiAgICAgICAgICBsZXQgbWF0Y2ggPSByZXN1bHRbMF07XG4gICAgICAgICAgLy8gQ2FuY2VsIGhhbmRsaW5nIHJlcXVlc3QgaWYgbmV3IG9uZSBjcmVhdGVkIG9yIHRoZXkgaGF2ZSBiZWVuIGNhbmNlbGVkLCB0byBhdm9pZCByYWNlIGNvbmRpdGlvbnNcbiAgICAgICAgICAvLyBpZiBtdWx0aXBsZSByb3V0ZXMgb3Igb3RoZXIgZXZlbnRzIGhhcHBlblxuICAgICAgICAgIGlmICh0aGlzLmNvbnRlbnRTdWJzY3JpcHRpb24gIT09IHN1YnNjcmlwdGlvbikge1xuICAgICAgICAgICAgaWYgKCFyZWNlaXZlZEZpcnN0UmVzcG9uc2UpIHtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAobWF0Y2ggJiYgbWF0Y2guaWQgPT09IHRoaXMubGFzdENvbnRlbnRJZCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHRoaXMubGFzdENvbnRlbnRJZCA9IG1hdGNoICYmIG1hdGNoLmlkO1xuXG4gICAgICAgICAgaWYgKHRoaXMudHJhbnNmZXJTdGF0ZSAmJiAhQnVpbGRlci5pc0Jyb3dzZXIpIHtcbiAgICAgICAgICAgIHRoaXMudHJhbnNmZXJTdGF0ZS5zZXQodGhpcy5zdGF0ZUtleVN0cmluZyBhcyBhbnksIHJlc3VsdCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICAgICAgICBjb25zdCB2aWV3UmVmID0gdGhpcy5fdmlld1JlZiE7XG5cbiAgICAgICAgICBpZiAodmlld1JlZi5kZXN0cm95ZWQpIHtcbiAgICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy51bnN1YnNjcmliZSgpO1xuICAgICAgICAgICAgaWYgKHRoaXMuY29udGVudFN1YnNjcmlwdGlvbikge1xuICAgICAgICAgICAgICB0aGlzLmNvbnRlbnRTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCByb290Tm9kZSA9IEJ1aWxkZXIuaXNCcm93c2VyICYmIHZpZXdSZWYucm9vdE5vZGVzWzBdO1xuXG4gICAgICAgICAgaWYgKEJ1aWxkZXIuaXNCcm93c2VyKSB7XG4gICAgICAgICAgICBpZiAocm9vdE5vZGUpIHtcbiAgICAgICAgICAgICAgaWYgKHJvb3ROb2RlICYmIHJvb3ROb2RlLmNsYXNzTGlzdC5jb250YWlucygnYnVpbGRlci1lZGl0b3ItaW5qZWN0ZWQnKSkge1xuICAgICAgICAgICAgICAgIHZpZXdSZWYuZGV0YWNoKCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgLy8gRklYTUU6IG5hc3R5IGhhY2sgdG8gZGV0ZWN0IHNlY29uZGFyeSB1cGRhdGVzIHZzIG9yaWdpbmFsLiBCdWlsZCBwcm9wZXIgc3VwcG9ydCBpbnRvIEpTIFNES1xuICAgICAgICAgIC8vIGlmICh0aGlzLl9jb250ZXh0LmxvYWRpbmcgfHwgcmVzdWx0Lmxlbmd0aCA+IHZpZXdSZWYuY29udGV4dC5yZXN1bHRzLmxlbmd0aCkge1xuICAgICAgICAgIHRoaXMuX2NvbnRleHQubG9hZGluZyA9IGZhbHNlO1xuICAgICAgICAgIGNvbnN0IHNlYXJjaCA9IHRoaXMuYnVpbGRlci5nZXRMb2NhdGlvbigpLnNlYXJjaCB8fCAnJztcbiAgICAgICAgICAvLyBUT0RPOiBob3cgaGFuZGxlIHNpbmdsZXRvbiB2cyBtdWx0aXBsZVxuICAgICAgICAgIGlmICghbWF0Y2ggJiYgc2VhcmNoLmluY2x1ZGVzKCdidWlsZGVyLnByZXZpZXc9JyArIHRoaXMuX2NvbnRleHQubW9kZWwpKSB7XG4gICAgICAgICAgICBtYXRjaCA9IHtcbiAgICAgICAgICAgICAgaWQ6ICdwcmV2aWV3JyxcbiAgICAgICAgICAgICAgbmFtZTogJ1ByZXZpZXcnLFxuICAgICAgICAgICAgICBkYXRhOiB7fSxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKHRoaXMuY29tcG9uZW50KSB7XG4gICAgICAgICAgICB0aGlzLmNvbXBvbmVudC5jb250ZW50TG9hZC5uZXh0KG1hdGNoKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKCdObyBjb21wb25lbnQhJyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChtYXRjaCkge1xuICAgICAgICAgICAgY29uc3Qgcm9vdE5vZGUgPSB0aGlzLl92aWV3UmVmIS5yb290Tm9kZXNbMF07XG4gICAgICAgICAgICB0aGlzLm1hdGNoSWQgPSBtYXRjaC5pZDtcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKHJvb3ROb2RlLCAnYnVpbGRlci1jb250ZW50LWVudHJ5LWlkJywgbWF0Y2guaWQpO1xuICAgICAgICAgICAgdGhpcy5tYXRjaCA9IG1hdGNoO1xuICAgICAgICAgICAgdmlld1JlZi5jb250ZXh0LiRpbXBsaWNpdCA9IG1hdGNoLmRhdGE7XG4gICAgICAgICAgICB2aWV3UmVmLmNvbnRleHQubWV0YSA9IG1hdGNoLm1ldGE7XG4gICAgICAgICAgICAvLyB2aWV3UmVmLmNvbnRleHQucmVzdWx0cyA9IHJlc3VsdC5tYXAoaXRlbSA9PiAoeyAuLi5pdGVtLmRhdGEsICRpZDogaXRlbS5pZCB9KSk7XG4gICAgICAgICAgICBpZiAoIWh5ZHJhdGUgJiYgdGhpcy5idWlsZGVyLmF1dG9UcmFjaykge1xuICAgICAgICAgICAgICB0aGlzLmJ1aWxkZXIudHJhY2tJbXByZXNzaW9uKG1hdGNoLmlkLCBtYXRjaC52YXJpYXRpb25JZCwgdW5kZWZpbmVkLCB7XG4gICAgICAgICAgICAgICAgY29udGVudDogbWF0Y2gsXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoIXZpZXdSZWYuZGVzdHJveWVkKSB7XG4gICAgICAgICAgICB2aWV3UmVmLmRldGVjdENoYW5nZXMoKTtcblxuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICB0aGlzLmJ1aWxkZXJDb21wb25lbnRTZXJ2aWNlLmNvbnRlbnRDb21wb25lbnRJbnN0YW5jZSAmJlxuICAgICAgICAgICAgICB0aGlzLmJ1aWxkZXJDb21wb25lbnRTZXJ2aWNlLmNvbnRlbnRDb21wb25lbnRJbnN0YW5jZS5wcmVyZW5kZXIgJiZcbiAgICAgICAgICAgICAgQnVpbGRlci5pc0Jyb3dzZXIgJiZcbiAgICAgICAgICAgICAgQnVpbGRlci5pc1N0YXRpY1xuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgIEJ1aWxkZXIubmV4dFRpY2soKCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmJ1aWxkZXJDb21wb25lbnRTZXJ2aWNlLmNvbnRlbnRDb21wb25lbnRJbnN0YW5jZSkge1xuICAgICAgICAgICAgICAgICAgdGhpcy5idWlsZGVyQ29tcG9uZW50U2VydmljZS5jb250ZW50Q29tcG9uZW50SW5zdGFuY2UuZmluZEFuZFJ1blNjcmlwdHMoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBUT0RPOiBpdCdzIHBvc3NpYmxlIHdlIGRvbid0IHdhbnQgYW55dGhpbmcgYmVsb3cgdG8gcnVuIGlmIHRoaXMgaGFzIGJlZW4gZGVzdHJveWVkXG4gICAgICAgICAgICBpZiAobWF0Y2ggJiYgbWF0Y2guZGF0YSAmJiBtYXRjaC5kYXRhLmFuaW1hdGlvbnMgJiYgQnVpbGRlci5pc0Jyb3dzZXIgJiYgIWh5ZHJhdGUpIHtcbiAgICAgICAgICAgICAgQnVpbGRlci5uZXh0VGljaygoKSA9PiB7XG4gICAgICAgICAgICAgICAgQnVpbGRlci5hbmltYXRvci5iaW5kQW5pbWF0aW9ucyhtYXRjaC5kYXRhLmFuaW1hdGlvbnMpO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKCFyZWNlaXZlZEZpcnN0UmVzcG9uc2UpIHtcbiAgICAgICAgICAgIHJlY2VpdmVkRmlyc3RSZXNwb25zZSA9IHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICAoZXJyb3IpID0+IHtcbiAgICAgICAgICBpZiAodGhpcy5jb21wb25lbnQpIHtcbiAgICAgICAgICAgIHRoaXMuY29tcG9uZW50LmNvbnRlbnRFcnJvci5uZXh0KGVycm9yKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKCdObyBjb21wb25lbnQhJyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICghcmVjZWl2ZWRGaXJzdFJlc3BvbnNlKSB7XG4gICAgICAgICAgICAvLyBUT0RPOiBob3cgdG8gem9uZSBlcnJvclxuICAgICAgICAgICAgcmVjZWl2ZWRGaXJzdFJlc3BvbnNlID0gdHJ1ZTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICkpO1xuICB9XG5cbiAgcHJpdmF0ZSBfdXBkYXRlVmlldygpIHtcbiAgICBpZiAodGhpcy5fY29udGV4dC5tb2RlbCkge1xuICAgICAgdGhpcy5fdmlld0NvbnRhaW5lci5jbGVhcigpO1xuICAgICAgaWYgKHRoaXMuX3RlbXBsYXRlUmVmKSB7XG4gICAgICAgIHRoaXMuX3ZpZXdSZWYgPSB0aGlzLl92aWV3Q29udGFpbmVyLmNyZWF0ZUVtYmVkZGVkVmlldyh0aGlzLl90ZW1wbGF0ZVJlZiwgdGhpcy5fY29udGV4dCk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBCdWlsZGVyQ29udGVudENvbnRleHQge1xuICAkaW1wbGljaXQ/OiBhbnk7XG4gIG1hdGNoPzogYW55O1xuICBtb2RlbD86IHN0cmluZztcbiAgbG9hZGluZyA9IHRydWU7XG4gIHJlc3VsdHM6IGFueVtdID0gW107XG4gIG1ldGE/OiBhbnk7XG59XG4iXX0=